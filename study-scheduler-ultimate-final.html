<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study 4.0 Ultimate í•™ìŠµ ìŠ¤ì¼€ì¤„ëŸ¬ - ì™„ì „íŒ</title>
    <style>
        :root {
            /* 7ë‹¨ê³„ ê¸€ì”¨ í¬ê¸° */
            --font-14: 14px;
            --font-15: 15px;
            --font-16: 16px;
            --font-17: 17px;
            --font-18: 18px;
            --font-19: 19px;
            --font-20: 20px;
            --current-font-size: var(--font-15);
            
            /* í—¤ë” ìƒ‰ìƒ ë³€ìˆ˜ */
            --header-color-light: #ff9966;
            --header-color-dark: #ff6633;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: var(--current-font-size);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* í—¤ë” */
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .header h1 {
            color: #2e3f6e;
            font-size: calc(var(--current-font-size) * 2.3);
        }

        /* ì„¤ì • íŒ¨ë„ - ìˆ¨ê¹€/í¼ì¹¨ ê¸°ëŠ¥ */
        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1001;
            border: 2px solid #FF69B4;
            transition: all 0.3s ease;
        }

        .settings-toggle:hover {
            transform: scale(1.1);
        }

        .settings-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            border: 2px solid #FF69B4;
            transition: all 0.3s ease;
            transform: translateX(100%);
            opacity: 0;
            visibility: hidden;
        }

        .settings-panel.open {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }

        .settings-panel h3 {
            margin: 0 0 10px 0;
            font-size: calc(var(--current-font-size) * 1.1);
            color: #666;
        }

        .settings-group {
            margin-bottom: 12px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 5px;
            font-size: calc(var(--current-font-size) * 0.9);
            color: #666;
        }

        /* ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: calc(var(--current-font-size) * 1.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .orange-circle {
            width: 20px;
            height: 20px;
            background: #ff9966;
            border-radius: 50%;
            display: inline-block;
        }

        /* ê°„í¸ ì…ë ¥ ì„¹ì…˜ */
        .quick-input-section {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border: 2px solid #fdcb6e;
        }

        .quick-input-section textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 2px solid #fdcb6e;
            border-radius: 5px;
            font-family: monospace;
            font-size: var(--current-font-size);
            resize: vertical;
        }

        /* êµì¬ë³„ ì»¨í…Œì´ë„ˆ */
        .subject-container {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .subject-container:hover {
            border-color: #ff9966;
            box-shadow: 0 2px 8px rgba(255, 153, 102, 0.2);
        }

        .subject-container.selected {
            border-color: #ff6633;
            border-width: 3px;
            box-shadow: 0 4px 12px rgba(255, 102, 51, 0.3);
        }

        .subject-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .subject-info {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .subject-info input[type="text"] {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: var(--current-font-size);
        }

        .subject-info input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: var(--current-font-size);
        }

        .subject-info select {
            width: 80px;
            padding: 8px;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 4px;
            font-size: var(--current-font-size);
        }

        /* ë²”ìœ„ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .ranges-container {
            margin-bottom: 15px;
        }

        .range-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .add-range-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: calc(var(--current-font-size) * 0.9);
            transition: all 0.2s;
            display: inline-block;
            margin-top: 10px;
        }

        .add-range-btn:hover {
            background: #059669;
        }

        .remove-range-btn, .remove-subject-btn {
            background: transparent;
            color: #ef4444;
            border: 1px solid #ef4444;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: calc(var(--current-font-size) * 0.85);
            transition: all 0.2s;
        }

        .remove-range-btn:hover, .remove-subject-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* íŒ¨í„´ ì»¨íŠ¸ë¡¤ */
        .pattern-controls {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .pattern-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .pattern-row > span {
            font-weight: bold;
            color: #666;
            min-width: 80px;
        }

        /* íŒ¨í„´ ë²„íŠ¼ë“¤ */
        .pattern-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: calc(var(--current-font-size) * 0.85);
            transition: all 0.2s;
            background: white;
        }

        .pattern-btn.active {
            background: #1e40af;
            color: white;
            border: 2px solid #1e40af;
            box-shadow: 0 2px 4px rgba(30,64,175,0.3);
        }

        .individual-day-btn {
            padding: 5px 10px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            cursor: pointer;
            font-size: calc(var(--current-font-size) * 0.8);
            min-width: 30px;
            text-align: center;
            background: white;
            transition: all 0.2s;
        }

        .individual-day-btn.active {
            background: #1e40af;
            color: white;
            border: 2px solid #1e40af;
        }

        /* ë³µìŠµ ë²„íŠ¼ */
        .review-btn {
            background: #1e40af;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .review-btn.disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .review-btn.active {
            background: #dc2626;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ì¼ì¼ í•™ìŠµëŸ‰ ë²„íŠ¼ */
        .daily-amount-btn {
            padding: 5px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: calc(var(--current-font-size) * 0.85);
            transition: all 0.2s;
            background: white;
        }

        .daily-amount-btn.active {
            background: #f59e0b;
            color: white;
            border-color: #d97706;
        }

        /* ì‹œê°ì  ë¯¸ë¦¬ë³´ê¸° - 3ì¹¸ êµ¬ì¡° */
        .preview-section {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
            border: 2px solid #f48fb1;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .preview-header h3 {
            color: #ad1457;
            margin: 0;
        }

        .preview-content {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
        }

        /* ì™¼ìª½ ì¹¸: ë¸”ë¡ ì‹œê°í™” */
        .preview-blocks-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
        }

        .preview-blocks {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .week-group {
            display: flex;
            gap: 4px;
        }

        .day-block {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            border: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
            transition: all 0.2s;
        }

        .day-block.non-study-day {
            background: #e5e7eb;
            color: #6b7280;
            border-color: #d1d5db;
        }

        .day-block.review-day {
            background: #e5e7eb !important;
            position: relative;
        }

        .day-block.review-day::after {
            content: "â—";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #1e40af;
            font-size: 16px;
        }

        /* íšŒë…ë³„ ìƒ‰ìƒ - í•µì‹¬ ì‹œìŠ¤í…œ */
        .round-1 { background: #1e40af; }
        .round-2 { background: #f59e0b; }
        .round-3 { background: #10b981; }
        .round-4 { background: #8b5cf6; }
        .round-5 { background: #ef4444; }

        .block-stats {
            margin-top: 10px;
            font-size: calc(var(--current-font-size) * 0.85);
            color: #666;
        }

        /* ì¤‘ê°„ ì¹¸: ì¶•ì•½ ë‹¬ë ¥ ê³„íší‘œ */
        .preview-calendar-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .compact-calendar {
            width: 100%;
            border-collapse: collapse;
            font-size: calc(var(--current-font-size) * 0.8);
        }

        .compact-calendar th {
            background: #f3f4f6;
            padding: 8px;
            border: 1px solid #e5e7eb;
            font-weight: bold;
            text-align: center;
        }

        .compact-calendar td {
            padding: 6px;
            border: 1px solid #e5e7eb;
            vertical-align: top;
            min-height: 60px;
            background: white;
            text-align: center;
        }

        .compact-calendar .date-num {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: calc(var(--current-font-size) * 0.75);
        }

        .compact-calendar .task-text {
            font-size: calc(var(--current-font-size) * 0.7);
            line-height: 1.2;
        }

        .compact-calendar .review-cell {
            background: #ffe4b5 !important;
        }

        /* ì˜¤ë¥¸ìª½ ì¹¸: ê³„ì‚° ìƒì„¸ */
        .preview-calculation {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            font-size: calc(var(--current-font-size) * 0.85);
            white-space: pre-wrap;
            color: #880e4f;
            line-height: 1.6;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: var(--current-font-size);
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF69B4, #ff1493);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,105,180,0.3);
        }

        .btn-secondary {
            background: white;
            color: #6b7280;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        .btn-generate {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            font-size: calc(var(--current-font-size) * 1.2);
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        /* íœ´ì¼ ì œì™¸ ìº˜ë¦°ë” */
        .exclude-calendar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-top: 15px;
        }

        .mini-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: calc(var(--current-font-size) * 0.9);
            background: #f8f9fa;
        }

        .calendar-day:hover:not(.disabled) {
            background: #e5e7eb;
        }

        .calendar-day.excluded {
            background: #ef4444;
            color: white;
        }

        .calendar-day.weekend {
            background: #f3f4f6;
        }

        /* ìµœì¢… ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .calendar-month {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }

        .calendar-month h3 {
            text-align: center;
            color: #2e3f6e;
            margin-bottom: 20px;
            font-size: calc(var(--current-font-size) * 1.8);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .compact-final-calendar {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #e5e7eb;
            margin: 0 auto;
            table-layout: auto;
        }

        .compact-final-calendar th {
            background: linear-gradient(135deg, var(--header-color-light), var(--header-color-dark));
            color: white;
            padding: 12px;
            border: 1px solid #ddd;
            font-weight: bold;
        }

        .compact-final-calendar td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: top;
            background: white;
            transition: all 0.3s ease;
            min-height: 80px;
        }

        .calendar-style-advanced2 td.weekend-sat {
            background: #eff6ff;
        }

        .calendar-style-advanced2 td.weekend-sun {
            background: #fef2f2;
        }

        .calendar-style-advanced2 .task:not(.print-mode)::before {
            content: "ğŸ”¹ ";
            margin-right: 3px;
        }

        .calendar-style-advanced2 td:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .date-num {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task {
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            font-size: calc(var(--current-font-size) * 0.75);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task.review-task {
            background: #ffe4b5 !important;
        }

        .task.print-mode::before {
            content: "â˜ ";
            font-size: calc(var(--current-font-size) * 0.8);
            margin-right: 3px;
        }

        /* ìƒ‰ìƒ í´ë˜ìŠ¤ */
        .color0 { background: #ffcccb; }
        .color1 { background: #fff2cc; }
        .color2 { background: #d4edda; }
        .color3 { background: #cce5ff; }
        .color4 { background: #e6ccff; }
        .color5 { background: #ffcc99; }

        .other-month {
            background: #f5f5f5 !important;
            color: #999;
        }

        /* í—¤ë” ìƒ‰ìƒ ì¡°í•© */
        .header-orange { --header-color-light: #ff9966; --header-color-dark: #ff6633; }
        .header-redorange { --header-color-light: #ff6666; --header-color-dark: #ff3333; }
        .header-pink { --header-color-light: #ff99cc; --header-color-dark: #ff6699; }
        .header-blue { --header-color-light: #6699ff; --header-color-dark: #3366ff; }
        .header-green { --header-color-light: #66cc66; --header-color-dark: #33cc33; }
        .header-purple { --header-color-light: #9966ff; --header-color-dark: #6633ff; }

        /* í†µê³„ ì„¹ì…˜ */
        .stats-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .stats-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-label {
            color: #6b7280;
            font-size: calc(var(--current-font-size) * 0.9);
            margin-bottom: 5px;
        }

        .stat-value {
            color: #2e3f6e;
            font-size: calc(var(--current-font-size) * 1.5);
            font-weight: bold;
        }

        /* ì•Œë¦¼ */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .hidden { display: none; }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1200px) {
            .preview-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .settings-toggle, .settings-panel {
                position: static;
                margin-bottom: 20px;
            }
        }

        /* í”„ë¦°íŠ¸ ìŠ¤íƒ€ì¼ */
        @media print {
            .settings-toggle,
            .settings-panel,
            .quick-input-section,
            .section:not(.stats-section),
            .btn,
            .pattern-controls {
                display: none !important;
            }
        }
    </style>
</head>
<body class="header-orange">
    <!-- ì„¤ì • í† ê¸€ ë²„íŠ¼ -->
    <div class="settings-toggle" onclick="toggleSettings()">
        âš™ï¸
    </div>

    <!-- ì„¤ì • íŒ¨ë„ -->
    <div class="settings-panel" id="settingsPanel">
        <h3>âš™ï¸ ì„¤ì •</h3>
        <div class="settings-group">
            <label>ë‹¬ë ¥ ìŠ¤íƒ€ì¼</label>
            <select id="calendarStyle" onchange="updateCalendarStyle()">
                <option value="basic">ê¸°ë³¸í˜•</option>
                <option value="advanced">ê³ ê¸‰í˜•1</option>
                <option value="advanced2">ê³ ê¸‰í˜•2</option>
                <option value="elegant">ì„¸ë ¨í˜•</option>
            </select>
        </div>
        <div class="settings-group">
            <label>ê¸€ì”¨ í¬ê¸°</label>
            <select id="fontSize" onchange="updateFontSize()">
                <option value="14">14í”½ì…€</option>
                <option value="15" selected>15í”½ì…€</option>
                <option value="16">16í”½ì…€</option>
                <option value="17">17í”½ì…€</option>
                <option value="18">18í”½ì…€</option>
                <option value="19">19í”½ì…€</option>
                <option value="20">20í”½ì…€</option>
            </select>
        </div>
        <div class="settings-group">
            <label>í—¤ë” ìƒ‰ìƒ</label>
            <select id="headerColor" onchange="updateHeaderColor()">
                <option value="orange" selected>ì˜¤ë Œì§€</option>
                <option value="redorange">ë ˆë“œì˜¤ë Œì§€</option>
                <option value="pink">í•‘í¬</option>
                <option value="blue">ë¸”ë£¨</option>
                <option value="green">ê·¸ë¦°</option>
                <option value="purple">í¼í”Œ</option>
            </select>
        </div>
        <div class="settings-group">
            <label>
                <input type="checkbox" id="printMode" onchange="togglePrintMode()">
                í”„ë¦°íŠ¸ ëª¨ë“œ
            </label>
        </div>
    </div>

    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 500 500">
                <circle cx="250" cy="250" r="240" fill="#FF69B4" />
                <circle cx="250" cy="250" r="215" fill="none" stroke="#FFFFFF" stroke-width="35" />
                <text x="250" y="176" text-anchor="middle" font-family="Arial Black, sans-serif" font-weight="900" font-size="82" fill="#FFFFFF" letter-spacing="2">STUDY</text>
                <text x="60" y="400" font-family="Arial Rounded MT Bold, Arial, sans-serif" font-weight="900" font-size="280" fill="#FFFFFF">4</text>
                <circle cx="350" cy="280" r="70" fill="none" stroke="#FFFFFF" stroke-width="40" />
                <circle cx="250" cy="420" r="30" fill="#FFFFFF" />
            </svg>
            <h1>Study 4.0 Ultimate í•™ìŠµ ìŠ¤ì¼€ì¤„ëŸ¬ - ì™„ì „íŒ</h1>
        </div>

        <!-- ì•Œë¦¼ -->
        <div id="alert" class="alert hidden"></div>

        <!-- ê°„í¸ ì…ë ¥ -->
        <div class="section quick-input-section">
            <h3>ğŸ“ ê°„í¸ ì…ë ¥ (ì„ íƒì‚¬í•­)</h3>
            <p style="margin-bottom: 10px; color: #2d3436;">
                í˜•ì‹: êµì¬ëª…, ì‹œì‘-ë, ì‹œì‘ì¼, ì¢…ë£Œì¼<br>
                <span style="font-size: 0.9em;">ğŸ’¡ ì‰¼í‘œ/íƒ­/ê³µë°± ëª¨ë‘ ê°€ëŠ¥ | ë‚ ì§œëŠ” 2025-09-10 ë˜ëŠ” 2025ë…„ 9ì›” 10ì¼ í˜•ì‹</span>
            </p>
            <textarea id="quickInput" placeholder="ì˜ˆì‹œ:
ì¸ì…‰ì…˜ ë…í•´, 44-266, 2025-09-10, 2025-09-24
ì¸ì…‰ì…˜ ë¬¸í•™ ê°œë…ì–´, 8-251, 2025-09-12, 2025-09-24"></textarea>
            <button class="btn btn-primary" onclick="parseQuickInput()">
                ğŸ“‹ íŒŒì‹±í•˜ì—¬ ì•„ë˜ ì–‘ì‹ì— ìë™ ì…ë ¥
            </button>
        </div>

        <!-- ì „ì²´ í•™ìŠµ ê¸°ê°„ -->
        <div class="section">
            <h3>ğŸ“… ì „ì²´ í•™ìŠµ ê¸°ê°„ (ê¸°ë³¸ê°’)</h3>
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <div>
                    <label style="margin-right: 10px;">ì‹œì‘ì¼:</label>
                    <input type="date" id="globalStartDate" onchange="updateGlobalDates()">
                </div>
                <div>
                    <label style="margin-right: 10px;">ì¢…ë£Œì¼:</label>
                    <input type="date" id="globalEndDate" onchange="updateGlobalDates()">
                </div>
                <span style="color: #6b7280; font-size: calc(var(--current-font-size) * 0.9);">
                    â€» ê°œë³„ ì„¤ì •í•˜ì§€ ì•Šì€ êµì¬ëŠ” ì´ ê¸°ê°„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
                </span>
            </div>
        </div>

        <!-- íœ´ì¼ ì œì™¸ ì„¤ì • -->
        <div class="section">
            <h3>ğŸš« íœ´ì¼ ì œì™¸ ì„¤ì •</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="toggleExcludeCalendar()">
                    ğŸ“… ì œì™¸ ë‚ ì§œ ì„ íƒ
                </button>
                <button class="btn btn-secondary" onclick="toggleWeekends()">
                    ì£¼ë§ ì „ì²´ ì œì™¸/í¬í•¨
                </button>
                <button class="btn btn-secondary" onclick="clearExcludedDates()">
                    ì´ˆê¸°í™”
                </button>
                <span id="excludedCount" style="margin-left: auto; color: #ef4444; font-weight: bold;">
                    ì œì™¸ëœ ë‚ ì§œ: 0ì¼
                </span>
            </div>
            <div id="excludeCalendar" class="exclude-calendar hidden">
                <select id="excludeMonth" onchange="renderExcludeCalendar()" style="margin-bottom: 10px; padding: 5px;">
                    <!-- ë™ì  ìƒì„± -->
                </select>
                <div id="miniCalendar" class="mini-calendar">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>

        <!-- êµì¬ ì •ë³´ ì„¹ì…˜ -->
        <div class="section">
            <h3><span class="orange-circle"></span> êµì¬ ì •ë³´</h3>
            <div id="subjectsContainer">
                <!-- ë™ì  ìƒì„± -->
            </div>
            <button class="btn btn-secondary" onclick="addSubject()" style="margin-top: 10px;">
                â• êµì¬ ì¶”ê°€
            </button>
        </div>

        <!-- ìƒì„± ë²„íŠ¼ -->
        <button class="btn btn-primary btn-generate" onclick="generateSchedule()">
            ğŸ¯ í•™ìŠµê³„íší‘œ ìƒì„±í•˜ê¸°
        </button>

        <!-- ê²°ê³¼ ì˜ì—­ -->
        <div id="resultSection" class="hidden">
            <div class="calendar-container">
                <div id="calendarContent">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>

            <!-- í†µê³„ ì„¹ì…˜ -->
            <div class="stats-section">
                <div class="stats-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 500 500">
                        <circle cx="250" cy="250" r="240" fill="#FF69B4" />
                        <circle cx="250" cy="250" r="215" fill="none" stroke="#FFFFFF" stroke-width="35" />
                        <text x="250" y="176" text-anchor="middle" font-family="Arial Black, sans-serif" font-weight="900" font-size="82" fill="#FFFFFF" letter-spacing="2">STUDY</text>
                        <text x="60" y="400" font-family="Arial Rounded MT Bold, Arial, sans-serif" font-weight="900" font-size="280" fill="#FFFFFF">4</text>
                        <circle cx="350" cy="280" r="70" fill="none" stroke="#FFFFFF" stroke-width="40" />
                        <circle cx="250" cy="420" r="30" fill="#FFFFFF" />
                    </svg>
                    <h3 style="color: #2e3f6e; margin: 0;">í•™ìŠµ í†µê³„</h3>
                </div>
                <div class="stats-grid" id="statsGrid">
                    <!-- ë™ì  ìƒì„± -->
                </div>
                <table id="summaryTable" style="width: 100%; margin-top: 20px; border-collapse: collapse; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <!-- ë™ì  ìƒì„± -->
                </table>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let subjects = [];
        let schedule = [];
        let excludedDates = new Set();
        let subjectIdCounter = 1;
        let isPrintMode = false;
        
        // ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ì €ì¥
        let previewScheduleData = {};

        // íšŒë… ë¹„ìœ¨ í•¨ìˆ˜ - í•µì‹¬ ì‹œìŠ¤í…œ
        function getRoundRatios(rounds) {
            const ratioMap = {
                1: [1.0],
                2: [0.6, 0.4],
                3: [0.5, 0.3, 0.2],
                4: [0.4, 0.3, 0.2, 0.1],
                5: [0.35, 0.25, 0.2, 0.12, 0.08]
            };
            return ratioMap[rounds] || [1.0];
        }

        // íšŒë…ë³„ ê¸°ê°„ ë¶„ë°° í•¨ìˆ˜ - í•µì‹¬ ì‹œìŠ¤í…œ
        function calculateRoundPeriods(totalDays, rounds) {
            const ratios = getRoundRatios(rounds);
            const periods = [];
            let dayOffset = 0;
            
            ratios.forEach((ratio, index) => {
                const roundDays = Math.ceil(totalDays * ratio);
                periods.push({
                    round: index + 1,
                    startDay: dayOffset + 1,
                    endDay: dayOffset + roundDays,
                    days: roundDays,
                    ratio: ratio
                });
                dayOffset += roundDays;
            });
            
            return periods;
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 3000);
        }

        // ì„¤ì • íŒ¨ë„ í† ê¸€
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('open');
        }

        // êµì¬ ì„ íƒ ì‹œ í…Œë‘ë¦¬ í‘œì‹œ
        function selectSubject(subjectId) {
            document.querySelectorAll('.subject-container').forEach(container => {
                container.classList.remove('selected');
            });
            
            const clickedContainer = document.querySelector(`[data-subject-id="${subjectId}"]`);
            if (clickedContainer) {
                clickedContainer.classList.add('selected');
            }
        }

        // êµì¬ ì¶”ê°€
        function addSubject() {
            const subject = {
                id: subjectIdCounter++,
                name: '',
                ranges: [{ start: '', end: '' }],
                unitType: 'page',
                startDate: document.getElementById('globalStartDate')?.value || '',
                endDate: document.getElementById('globalEndDate')?.value || '',
                useIndividual: false,
                pattern: {
                    dayPattern: ['daily'],
                    individualDays: [],
                    rounds: 1,
                    reviewMode: false,
                    reviewDates: [],
                    distributionType: 'equal',
                    dailyAmount: 5
                }
            };
            subjects.push(subject);
            renderSubjects();
        }

        // êµì¬ ëª©ë¡ ë Œë”ë§
        function renderSubjects() {
            const container = document.getElementById('subjectsContainer');
            container.innerHTML = '';

            subjects.forEach((subject, index) => {
                const div = document.createElement('div');
                div.className = 'subject-container';
                div.setAttribute('data-subject-id', subject.id);
                div.onclick = (e) => {
                    if (!e.target.matches('button') && !e.target.matches('input') && !e.target.matches('select')) {
                        selectSubject(subject.id);
                    }
                };
                
                let html = `
                    <div class="subject-header">
                        <h4>êµì¬ ${index + 1}</h4>
                        ${subjects.length > 1 ? `<button class="remove-subject-btn" onclick="removeSubject(${subject.id}); event.stopPropagation()">X</button>` : ''}
                    </div>
                    
                    <div class="subject-info">
                        <input type="text" 
                               placeholder="êµì¬ëª…" 
                               value="${subject.name}" 
                               onchange="updateSubject(${subject.id}, 'name', this.value)"
                               onclick="event.stopPropagation()">
                `;
                
                // ì²« ë²ˆì§¸ ë²”ìœ„
                const firstRange = subject.ranges[0];
                html += `
                    <input type="number" 
                           placeholder="ì‹œì‘" 
                           value="${firstRange.start}" 
                           onchange="updateRange(${subject.id}, 0, 'start', this.value)"
                           onclick="event.stopPropagation()">
                    <span>~</span>
                    <input type="number" 
                           placeholder="ë" 
                           value="${firstRange.end}" 
                           onchange="updateRange(${subject.id}, 0, 'end', this.value)"
                           onclick="event.stopPropagation()">
                    <select onchange="updateSubject(${subject.id}, 'unitType', this.value)" onclick="event.stopPropagation()">
                        <option value="page" ${subject.unitType === 'page' ? 'selected' : ''}>í˜ì´ì§€</option>
                        <option value="lesson" ${subject.unitType === 'lesson' ? 'selected' : ''}>ê°•</option>
                        <option value="number" ${subject.unitType === 'number' ? 'selected' : ''}>ë²ˆ</option>
                        <option value="day" ${subject.unitType === 'day' ? 'selected' : ''}>Day</option>
                    </select>
                </div>
                `;
                
                // ì¶”ê°€ ë²”ìœ„ë“¤
                if (subject.ranges.length > 1) {
                    html += '<div class="ranges-container">';
                    for (let i = 1; i < subject.ranges.length; i++) {
                        const range = subject.ranges[i];
                        html += `
                            <div class="range-item">
                                <span style="color: #666;">ë²”ìœ„ ${i + 1}:</span>
                                <input type="number" 
                                       placeholder="ì‹œì‘" 
                                       value="${range.start}" 
                                       onchange="updateRange(${subject.id}, ${i}, 'start', this.value)"
                                       onclick="event.stopPropagation()">
                                <span>~</span>
                                <input type="number" 
                                       placeholder="ë" 
                                       value="${range.end}" 
                                       onchange="updateRange(${subject.id}, ${i}, 'end', this.value)"
                                       onclick="event.stopPropagation()">
                                <button class="remove-range-btn" onclick="removeRange(${subject.id}, ${i}); event.stopPropagation()">X</button>
                            </div>
                        `;
                    }
                    html += '</div>';
                }
                
                // ë²”ìœ„ ì¶”ê°€ ë²„íŠ¼
                if (subject.ranges.length < 5) {
                    html += `<button class="add-range-btn" onclick="addRange(${subject.id}); event.stopPropagation()">+ ë²”ìœ„ ì¶”ê°€</button>`;
                }
                
                // ê°œë³„ ê¸°ê°„ ì„¤ì •
                html += `
                    <div style="margin-top: 10px;">
                        <label onclick="event.stopPropagation()">
                            <input type="checkbox" 
                                   ${subject.useIndividual ? 'checked' : ''} 
                                   onchange="toggleIndividual(${subject.id})"
                                   onclick="event.stopPropagation()">
                            ê°œë³„ ê¸°ê°„ ì„¤ì •
                        </label>
                        ${subject.useIndividual ? `
                            <input type="date" 
                                   value="${subject.startDate}" 
                                   onchange="updateSubject(${subject.id}, 'startDate', this.value)"
                                   onclick="event.stopPropagation()">
                            ~
                            <input type="date" 
                                   value="${subject.endDate}" 
                                   onchange="updateSubject(${subject.id}, 'endDate', this.value)"
                                   onclick="event.stopPropagation()">
                        ` : ''}
                    </div>
                `;
                
                // íŒ¨í„´ ì»¨íŠ¸ë¡¤
                html += createPatternControls(subject);
                
                // ë¯¸ë¦¬ë³´ê¸°
                const preview = createPreview(subject);
                if (preview) {
                    html += preview;
                }
                
                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        // íŒ¨í„´ ì»¨íŠ¸ë¡¤ ìƒì„±
        function createPatternControls(subject) {
            const pattern = subject.pattern;
            const reviewDisabled = pattern.rounds > 1;
            const reviewClass = reviewDisabled ? 'disabled' : (pattern.reviewMode ? 'active' : '');
            
            return `
                <div class="pattern-controls" onclick="event.stopPropagation()">
                    <div class="pattern-row">
                        <span>ìš”ì¼ íŒ¨í„´:</span>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            ${['ì›”ìˆ˜ê¸ˆ', 'í™”ëª©í† ', 'í™€ìˆ˜ë‚ ', 'ì§ìˆ˜ë‚ ', 'ë§¤ì¼'].map((label, i) => {
                                const ids = ['mon-wed-fri', 'tue-thu-sat', 'odd-days', 'even-days', 'daily'];
                                return `<div class="pattern-btn ${pattern.dayPattern.includes(ids[i]) ? 'active' : ''}" 
                                        onclick="togglePattern(${subject.id}, '${ids[i]}'); event.stopPropagation()">${label}</div>`;
                            }).join('')}
                            <span>|</span>
                            ${['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'].map((label, i) => {
                                const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                                return `<div class="individual-day-btn ${pattern.individualDays.includes(days[i]) ? 'active' : ''}" 
                                        onclick="toggleIndividualDay(${subject.id}, '${days[i]}'); event.stopPropagation()">${label}</div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div class="pattern-row">
                        <span>ë¶„ëŸ‰ ë°°ë¶„:</span>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            ${[1, 2, 3, 4, 5].map(r => 
                                `<div class="pattern-btn ${pattern.rounds === r ? 'active' : ''}" 
                                      onclick="setRounds(${subject.id}, ${r}); event.stopPropagation()">${r}íšŒë…</div>`
                            ).join('')}
                            <button class="review-btn ${reviewClass}" 
                                    onclick="toggleReviewMode(${subject.id}); event.stopPropagation()" 
                                    ${reviewDisabled ? 'disabled' : ''}>â—</button>
                            <span>|</span>
                            <div class="pattern-btn ${pattern.distributionType === 'equal' ? 'active' : ''}" 
                                 onclick="setDistribution(${subject.id}, 'equal'); event.stopPropagation()">ê· ë“±ë¶„ì‚°</div>
                            <div class="pattern-btn ${pattern.distributionType === 'sequential' ? 'active' : ''}" 
                                 onclick="setDistribution(${subject.id}, 'sequential'); event.stopPropagation()">ìˆœì°¨ë°°ë¶„</div>
                        </div>
                    </div>
                    ${pattern.distributionType === 'sequential' ? `
                        <div class="pattern-row">
                            <span>ì¼ì¼ í•™ìŠµëŸ‰:</span>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                ${[1, 2, 3, 5, 10, 15, 20, 25, 30].map(a => 
                                    `<div class="daily-amount-btn ${pattern.dailyAmount === a ? 'active' : ''}" 
                                          onclick="setDailyAmount(${subject.id}, ${a}); event.stopPropagation()">${a}p</div>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
        function createPreview(subject) {
            const totalPages = calculateTotalPages(subject);
            if (totalPages === 0) return '';
            
            const studyDates = calculateStudyDates(subject);
            if (studyDates.length === 0) {
                return '<div class="preview-section"><div style="padding: 15px; color: #d63384;">í•™ìŠµ ê°€ëŠ¥í•œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';
            }
            
            // íšŒë…ìˆ˜ ì‹œìŠ¤í…œìœ¼ë¡œ ìŠ¤ì¼€ì¤„ ê³„ì‚°
            const scheduleData = calculateScheduleForSubject(subject, studyDates, totalPages);
            previewScheduleData[subject.id] = scheduleData;
            
            const reviewModeText = subject.pattern.reviewMode ? ' (ë³µìŠµ ëª¨ë“œ: íšŒìƒ‰ ë¸”ë¡ í´ë¦­)' : '';
            
            return `
                <div class="preview-section">
                    <div class="preview-header">
                        <span class="orange-circle"></span>
                        <h3>${subject.name} ë¯¸ë¦¬ë³´ê¸°${reviewModeText}</h3>
                    </div>
                    <div class="preview-content">
                        ${generateBlocksColumn(subject, studyDates, scheduleData)}
                        ${generateCompactCalendarColumn(subject, scheduleData)}
                        ${generateCalculationColumn(subject, studyDates, totalPages, scheduleData)}
                    </div>
                </div>
            `;
        }

        // íšŒë…ìˆ˜ ìŠ¤ì¼€ì¤„ ê³„ì‚° í•¨ìˆ˜ - í•µì‹¬ ì‹œìŠ¤í…œ
        function calculateScheduleForSubject(subject, studyDates, totalPages) {
            const scheduleData = [];
            const pattern = subject.pattern;

            const ranges = subject.ranges
                .filter(r => r.start && r.end)
                .map(r => ({ start: parseInt(r.start), end: parseInt(r.end) }));

            if (ranges.length === 0) return scheduleData;

            let remainingDates = [...studyDates];

            for (let round = 1; round <= pattern.rounds; round++) {
                if (remainingDates.length === 0) break;

                const result = generateRoundSchedule(
                    remainingDates,
                    totalPages,
                    ranges,
                    round,
                    pattern.distributionType,
                    pattern.dailyAmount
                );

                scheduleData.push(...result.schedule);

                // ì‚¬ìš©ëœ ë‚ ì§œë¥¼ ì œì™¸í•˜ê³  ë‚¨ì€ ë‚ ì§œë¥¼ ì—…ë°ì´íŠ¸
                remainingDates = remainingDates.slice(result.daysUsed);
            }

            // ë³µìŠµì¼ ì²˜ë¦¬ (1íšŒë…ì—ì„œë§Œ)
            if (pattern.reviewDates.length > 0 && pattern.rounds === 1) {
                addReviewSchedule(scheduleData, pattern.reviewDates);
            }

            // ë‚ ì§œìˆœ ì •ë ¬
            scheduleData.sort((a, b) => new Date(a.date) - new Date(b.date));

            return scheduleData;
        }

        // íšŒë…ë³„ ìŠ¤ì¼€ì¤„ ìƒì„±
        function generateRoundSchedule(roundDates, totalPages, ranges, round, distributionType, dailyAmount) {
            const roundSchedule = [];
            
            if (distributionType === 'equal') {
                // ê· ë“± ë¶„ì‚°
                const dailyAverage = totalPages / roundDates.length;
                let actualDates = roundDates;
                
                if (dailyAverage < 1.0) {
                    const neededDays = totalPages;
                    actualDates = roundDates.slice(0, neededDays);
                }
                
                if (actualDates.length === 0) return roundSchedule;
                
                // í˜ì´ì§€ ë¶„ë°°
                let currentRangeIndex = 0;
                let currentRangeOffset = 0;
                let totalPagesAssigned = 0;
                
                actualDates.forEach((date, dayIndex) => {
                    if (totalPagesAssigned >= totalPages) return;
                    if (currentRangeIndex >= ranges.length) return;
                    
                    // í•˜ë£¨ í•™ìŠµëŸ‰ ê³„ì‚°
                    const remainingDays = actualDates.length - dayIndex;
                    const remainingPages = totalPages - totalPagesAssigned;
                    const todayPages = Math.ceil(remainingPages / remainingDays);
                    
                    if (todayPages <= 0) return;
                    
                    // ì‹¤ì œ í˜ì´ì§€ ë²ˆí˜¸ ê³„ì‚°
                    let pagesAssigned = 0;
                    let startPage = null;
                    let endPage = null;
                    
                    while (pagesAssigned < todayPages && currentRangeIndex < ranges.length) {
                        const currentRange = ranges[currentRangeIndex];
                        const rangeRemaining = currentRange.end - (currentRange.start + currentRangeOffset) + 1;
                        const toAssign = Math.min(todayPages - pagesAssigned, rangeRemaining);
                        
                        if (startPage === null) {
                            startPage = currentRange.start + currentRangeOffset;
                        }
                        endPage = currentRange.start + currentRangeOffset + toAssign - 1;
                        
                        // ë²”ìœ„ ì´ˆê³¼ ë°©ì§€
                        if (endPage > currentRange.end) {
                            endPage = currentRange.end;
                            toAssign = endPage - startPage + 1;
                        }
                        
                        pagesAssigned += toAssign;
                        currentRangeOffset += toAssign;
                        
                        if (currentRangeOffset >= (currentRange.end - currentRange.start + 1)) {
                            currentRangeIndex++;
                            currentRangeOffset = 0;
                        }
                    }
                    
                    if (startPage !== null && endPage !== null && startPage <= endPage) {
                        roundSchedule.push({
                            date: formatDate(date),
                            startPage: startPage,
                            endPage: endPage,
                            round: round,
                            isReview: false
                        });
                        
                        totalPagesAssigned += pagesAssigned;
                    }
                });
            } else {
                // ìˆœì°¨ ë°°ë¶„
                let currentRangeIndex = 0;
                let currentRangeOffset = 0;
                let totalPagesAssigned = 0;
                
                for (const date of roundDates) {
                    if (totalPagesAssigned >= totalPages) break;
                    if (currentRangeIndex >= ranges.length) break;
                    
                    const todayPages = Math.min(dailyAmount, totalPages - totalPagesAssigned);
                    if (todayPages <= 0) break;
                    
                    let pagesAssigned = 0;
                    let startPage = null;
                    let endPage = null;
                    
                    while (pagesAssigned < todayPages && currentRangeIndex < ranges.length) {
                        const currentRange = ranges[currentRangeIndex];
                        const rangeRemaining = currentRange.end - (currentRange.start + currentRangeOffset) + 1;
                        const toAssign = Math.min(todayPages - pagesAssigned, rangeRemaining);
                        
                        if (startPage === null) {
                            startPage = currentRange.start + currentRangeOffset;
                        }
                        endPage = currentRange.start + currentRangeOffset + toAssign - 1;
                        
                        // ë²”ìœ„ ì´ˆê³¼ ë°©ì§€
                        if (endPage > currentRange.end) {
                            endPage = currentRange.end;
                            toAssign = endPage - startPage + 1;
                        }
                        
                        pagesAssigned += toAssign;
                        currentRangeOffset += toAssign;
                        
                        if (currentRangeOffset >= (currentRange.end - currentRange.start + 1)) {
                            currentRangeIndex++;
                            currentRangeOffset = 0;
                        }
                    }
                    
                    if (startPage !== null && endPage !== null && startPage <= endPage) {
                        roundSchedule.push({
                            date: formatDate(date),
                            startPage: startPage,
                            endPage: endPage,
                            round: round,
                            isReview: false
                        });
                        
                        totalPagesAssigned += pagesAssigned;
                    }
                }
            }
            
            return { schedule: roundSchedule, daysUsed: roundSchedule.length };
        }

        // ë³µìŠµ ì¼ì • ì¶”ê°€
        function addReviewSchedule(scheduleData, reviewDates) {
            // ì£¼ë³„ í•™ìŠµ ë°ì´í„° ê·¸ë£¹í™”
            const weeklyData = {};
            
            scheduleData.forEach(item => {
                if (!item.isReview) {
                    const date = new Date(item.date);
                    const weekStart = getWeekStart(date);
                    const weekKey = formatDate(weekStart);
                    
                    if (!weeklyData[weekKey]) {
                        weeklyData[weekKey] = {
                            minPage: Infinity,
                            maxPage: -Infinity,
                            reviewDates: []
                        };
                    }
                    
                    weeklyData[weekKey].minPage = Math.min(weeklyData[weekKey].minPage, item.startPage);
                    weeklyData[weekKey].maxPage = Math.max(weeklyData[weekKey].maxPage, item.endPage);
                }
            });
            
            // ë³µìŠµì¼ í• ë‹¹
            reviewDates.forEach(reviewDate => {
                const date = new Date(reviewDate);
                const weekStart = getWeekStart(date);
                const weekKey = formatDate(weekStart);
                
                if (weeklyData[weekKey]) {
                    weeklyData[weekKey].reviewDates.push(reviewDate);
                }
            });
            
            // ë³µìŠµëŸ‰ ë¶„ë°°
            Object.keys(weeklyData).forEach(weekKey => {
                const weekInfo = weeklyData[weekKey];
                if (weekInfo.reviewDates.length > 0 && weekInfo.minPage !== Infinity) {
                    const totalWeekPages = weekInfo.maxPage - weekInfo.minPage + 1;
                    const pagesPerReview = Math.ceil(totalWeekPages / weekInfo.reviewDates.length);
                    
                    weekInfo.reviewDates.sort().forEach((reviewDate, index) => {
                        const reviewStart = weekInfo.minPage + (index * pagesPerReview);
                        const reviewEnd = Math.min(reviewStart + pagesPerReview - 1, weekInfo.maxPage);
                        
                        if (reviewStart <= reviewEnd) {
                            scheduleData.push({
                                date: reviewDate,
                                startPage: reviewStart,
                                endPage: reviewEnd,
                                round: 1,
                                isReview: true
                            });
                        }
                    });
                }
            });
        }

        // â˜… í•µì‹¬ ìˆ˜ì •: ë¸”ë¡ ì‹œê°í™” ìƒì„± - scheduleData ê¸°ì¤€ìœ¼ë¡œ ì™„ì „ ì¬ì‘ì„±
        function generateBlocksColumn(subject, studyDates, scheduleData) {
            
            const start = new Date(subject.startDate);
            const end = new Date(subject.endDate);
            const blocks = [];
            
            // 1. ë°ì´í„° ë§µ ìƒì„± (Single Source of Truth)
            const scheduleMap = new Map();
            scheduleData.forEach(item => {
                scheduleMap.set(item.date, item);
            });
            
            // 2. ë³µìŠµì¼ ì„¸íŠ¸ ìƒì„±
            const reviewDates = new Set(subject.pattern.reviewDates);
            
            // 3. ì „ì²´ ê¸°ê°„ ìˆœíšŒí•˜ë˜ ë°ì´í„° ë§µ ê¸°ì¤€ìœ¼ë¡œë§Œ íŒë‹¨
            let current = new Date(start);
            while (current <= end) {
                const dateStr = formatDate(current);
                const scheduleItem = scheduleMap.get(dateStr);
                
                if (scheduleItem && !scheduleItem.isReview) {
                    // í•™ìŠµì¼: scheduleDataì˜ round ì •ë³´ ì‚¬ìš©
                    blocks.push(`<div class="day-block round-${scheduleItem.round}"></div>`);
                } else if (scheduleItem && scheduleItem.isReview) {
                    // ë³µìŠµì¼: scheduleDataì˜ ë³µìŠµ ì •ë³´ ì‚¬ìš©  
                    blocks.push(`<div class="day-block review-day"></div>`);
                } else if (reviewDates.has(dateStr)) {
                    // ë³µìŠµ ì„¤ì •ì¼ (ë°ì´í„° ì—†ì–´ë„)
                    blocks.push(`<div class="day-block review-day" onclick="toggleReviewDate(${subject.id}, '${dateStr}'); event.stopPropagation()"></div>`);
                } else {
                    // íœ´ì‹ì¼
                    const clickHandler = subject.pattern.reviewMode ? 
                        `onclick="toggleReviewDate(${subject.id}, '${dateStr}'); event.stopPropagation()"` : '';
                    blocks.push(`<div class="day-block non-study-day" ${clickHandler}></div>`);
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            // ì£¼ì°¨ë³„ ê·¸ë£¹í•‘
            const weekGroups = [];
            for (let i = 0; i < blocks.length; i += 7) {
                weekGroups.push(`<div class="week-group">${blocks.slice(i, i + 7).join('')}</div>`);
            }
            
            // íšŒë…ë³„ í†µê³„ ê³„ì‚°
            const roundStats = {};
            scheduleData.filter(d => !d.isReview).forEach(d => {
                roundStats[d.round] = (roundStats[d.round] || 0) + 1;
            });
            
            const reviewDays = subject.pattern.reviewDates.length;
            const totalStudyDays = Object.values(roundStats).reduce((sum, days) => sum + days, 0);
            const restDays = blocks.length - totalStudyDays - reviewDays;
            
            let statsText = '';
            Object.keys(roundStats).sort().forEach(round => {
                statsText += `${round}íšŒë… ${roundStats[round]}ì¼ | `;
            });
            if (reviewDays > 0) statsText += `ë³µìŠµ ${reviewDays}ì¼ | `;
            statsText += `íœ´ì‹ ${restDays}ì¼`;
            
            
            return `
                <div class="preview-blocks-container">
                    <div class="preview-blocks">${weekGroups.join('')}</div>
                    <div class="block-stats">${statsText}</div>
                </div>
            `;
        }

        // ì¶•ì•½ ë‹¬ë ¥ ì»¬ëŸ¼ ìƒì„± 
        function generateCompactCalendarColumn(subject, scheduleData) {
            if (!scheduleData || scheduleData.length === 0) {
                return '<div class="preview-calendar-container">ë°ì´í„° ì—†ìŒ</div>';
            }
            
            // ì‚¬ìš©ë˜ëŠ” ìš”ì¼ ì¶”ì¶œ
            const usedDays = new Set();
            const pattern = subject.pattern;
            
            if (pattern.individualDays.length > 0) {
                pattern.individualDays.forEach(day => {
                    const dayIndex = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].indexOf(day);
                    if (dayIndex !== -1) usedDays.add(dayIndex + 1);
                });
            } else {
                pattern.dayPattern.forEach(pat => {
                    switch(pat) {
                        case 'daily':
                            [1,2,3,4,5,6,0].forEach(d => usedDays.add(d));
                            break;
                        case 'mon-wed-fri':
                            [1,3,5].forEach(d => usedDays.add(d));
                            break;
                        case 'tue-thu-sat':
                            [2,4,6].forEach(d => usedDays.add(d));
                            break;
                    }
                });
            }
            
            // ë³µìŠµì¼ë„ í¬í•¨
            subject.pattern.reviewDates.forEach(dateStr => {
                const date = new Date(dateStr);
                usedDays.add(date.getDay());
            });
            
            const sortedDays = Array.from(usedDays).sort((a, b) => {
                const aIndex = a === 0 ? 6 : a - 1;
                const bIndex = b === 0 ? 6 : b - 1;
                return aIndex - bIndex;
            });
            
            // ìš”ì¼ëª… ë§¤í•‘
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            
            let html = '<div class="preview-calendar-container"><table class="compact-calendar"><thead><tr>';
            sortedDays.forEach(dayIndex => {
                html += `<th>${dayNames[dayIndex]}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // ë‚ ì§œë³„ ë°ì´í„° ê·¸ë£¹í™”
            const dateData = {};
            scheduleData.forEach(item => {
                dateData[item.date] = item;
            });
            
            // ì£¼ì°¨ë³„ ë°ì´í„° ìƒì„±
            const weeks = [];
            const dates = Object.keys(dateData).sort();
            if (dates.length > 0) {
                const firstDate = new Date(dates[0]);
                const lastDate = new Date(dates[dates.length - 1]);
                
                let current = new Date(firstDate);
                current.setDate(current.getDate() - current.getDay() + 1);
                
                while (current <= lastDate) {
                    const week = {};
                    for (let i = 0; i < 7; i++) {
                        const dateStr = formatDate(current);
                        const data = dateData[dateStr];
                        if (data && sortedDays.includes(current.getDay())) {
                            week[current.getDay()] = {
                                date: current.getDate(),
                                data: data
                            };
                        }
                        current.setDate(current.getDate() + 1);
                    }
                    
                    if (Object.keys(week).length > 0) {
                        weeks.push(week);
                    }
                }
            }
            
            // í…Œì´ë¸” í–‰ ìƒì„±
            weeks.forEach(week => {
                html += '<tr>';
                sortedDays.forEach(dayIndex => {
                    const dayData = week[dayIndex];
                    if (dayData) {
                        const cellClass = dayData.data.isReview ? 'review-cell' : '';
                        const reviewText = dayData.data.isReview ? '<br>(ë³µìŠµ)' : '';
                        const roundText = dayData.data.round > 1 ? ` (${dayData.data.round}íšŒë…)` : '';
                        html += `<td class="${cellClass}">
                                    <div class="date-num">${dayData.date}</div>
                                    <div class="task-text">${dayData.data.startPage}-${dayData.data.endPage}p${roundText}${reviewText}</div>
                                 </td>`;
                    } else {
                        html += '<td></td>';
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        // ê³„ì‚° ìƒì„¸ ìƒì„± (7ê°œ í•„ìˆ˜ í•­ëª© + íšŒë… ì •ë³´)
        function generateCalculationColumn(subject, studyDates, totalPages, scheduleData) {
            const pattern = subject.pattern;
            const unitLabel = getUnitLabel(subject.unitType);
            const start = new Date(subject.startDate);
            const end = new Date(subject.endDate);
            const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            let calculation = '';
            
            // 1. ë¶„ë°°ë°©ì‹
            calculation += `â€¢ ë¶„ë°°ë°©ì‹: ${pattern.distributionType === 'equal' ? 'ê· ë“±ë¶„ì‚°' : 'ìˆœì°¨ë°°ë¶„'} (${pattern.rounds}íšŒë…)\n`;
            
            // 2. ì´í•™ìŠµê¸°ê°„ ì¤‘ ì‹¤ì œí•™ìŠµì¼
            const actualStudyDays = scheduleData.filter(d => !d.isReview).length;
            calculation += `â€¢ ì´í•™ìŠµê¸°ê°„ ì¤‘ ì‹¤ì œí•™ìŠµì¼: ì´ ${totalDays}ì¼ ê¸°ê°„ ì¤‘ ì‹¤ì œ í•™ìŠµì¼ ${actualStudyDays}ì¼\n`;
            
            // 3. í•™ìŠµë²”ìœ„
            const rangeText = subject.ranges.map(r => `${r.start}-${r.end}`).join(' + ');
            const totalContent = totalPages * pattern.rounds;
            calculation += `â€¢ í•™ìŠµë²”ìœ„: ì´ ${totalPages}${unitLabel} Ã— ${pattern.rounds}íšŒë… = ${totalContent}${unitLabel} (${rangeText})\n`;
            
            // 4. íšŒë…ë³„ ê¸°ê°„ (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
            const roundDays = {};
            scheduleData.filter(d => !d.isReview).forEach(d => {
                roundDays[d.round] = (roundDays[d.round] || 0) + 1;
            });
            const periodText = Object.keys(roundDays).map(r => `${r}íšŒë… ${roundDays[r]}ì¼`).join(', ');
            calculation += `â€¢ íšŒë…ë³„ ê¸°ê°„: ${periodText}\n`;

            // 5. íšŒë…ë³„ ì¼í‰ê·  (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
            const avgText = Object.keys(roundDays).map(r => {
                const days = roundDays[r];
                if (days === 0) return `${r}íšŒë… 0${unitLabel}/ì¼`;
                return `${r}íšŒë… ${(totalPages / days).toFixed(1)}${unitLabel}/ì¼`;
            }).join(', ');
            calculation += `â€¢ íšŒë…ë³„ ì¼í‰ê· : ${avgText || 'ê³„ì‚° ë¶ˆê°€'}\n`;
            
            // 6. ë¶„ë°°ë°©ì‹ ìƒì„¸
            if (pattern.distributionType === 'equal') {
                calculation += `â€¢ ë¶„ë°°ë°©ì‹: ê° íšŒë…ë§ˆë‹¤ ì „ì²´ ë‚´ìš© ë°˜ë³µ, ì£¼ë‹¨ìœ„ ê³„ì‚° í›„ ì£¼ë‚´ ë¶„ë°°\n`;
            } else {
                calculation += `â€¢ ë¶„ë°°ë°©ì‹: ê° íšŒë…ë§ˆë‹¤ ì¼ì¼ ${pattern.dailyAmount}${unitLabel} ê³ ì •\n`;
            }
            
            // 7. ë³µìŠµì¼
            if (pattern.reviewDates.length > 0 && pattern.rounds === 1) {
                const reviewItems = scheduleData.filter(d => d.isReview);
                if (reviewItems.length > 0) {
                    const reviewRanges = reviewItems.map(r => `${r.startPage}-${r.endPage}p`).join(', ');
                    calculation += `â€¢ ë³µìŠµì¼: ${reviewRanges}\n`;
                } else {
                    calculation += `â€¢ ë³µìŠµì¼: ì„¤ì •ë¨ (${pattern.reviewDates.length}ì¼)\n`;
                }
            } else if (pattern.rounds > 1) {
                calculation += `â€¢ ë³µìŠµì¼: 2íšŒë… ì´ìƒì—ì„œëŠ” ë¶ˆê°€ëŠ¥\n`;
            } else {
                calculation += `â€¢ ë³µìŠµì¼: ì—†ìŒ\n`;
            }
            
            return `<div class="preview-calculation">${calculation}</div>`;
        }

        // í•™ìŠµ ë‚ ì§œ ê³„ì‚°
        function calculateStudyDates(subject) {
            const start = new Date(subject.startDate);
            const end = new Date(subject.endDate);
            const dates = [];
            let current = new Date(start);
            const pattern = subject.pattern;

            while (current <= end) {
                const dateStr = formatDate(current);
                
                if (!excludedDates.has(dateStr) && !pattern.reviewDates.includes(dateStr)) {
                    const dayOfWeek = current.getDay();
                    const dayOfMonth = current.getDate();
                    let shouldStudy = false;

                    if (pattern.individualDays.length > 0) {
                        const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                        const currentDayName = dayNames[dayOfWeek];
                        shouldStudy = pattern.individualDays.includes(currentDayName);
                    } else {
                        for (const pat of pattern.dayPattern) {
                            switch(pat) {
                                case 'daily':
                                    shouldStudy = true;
                                    break;
                                case 'mon-wed-fri':
                                    shouldStudy = [1, 3, 5].includes(dayOfWeek);
                                    break;
                                case 'tue-thu-sat':
                                    shouldStudy = [2, 4, 6].includes(dayOfWeek);
                                    break;
                                case 'odd-days':
                                    shouldStudy = (dayOfMonth % 2 === 1);
                                    break;
                                case 'even-days':
                                    shouldStudy = (dayOfMonth % 2 === 0);
                                    break;
                            }
                            if (shouldStudy) break;
                        }
                    }

                    if (shouldStudy) {
                        dates.push(new Date(current));
                    }
                }
                
                current.setDate(current.getDate() + 1);
            }

            return dates;
        }

        // ì´ í˜ì´ì§€ ê³„ì‚°
        function calculateTotalPages(subject) {
            let total = 0;
            subject.ranges.forEach(range => {
                if (range.start && range.end) {
                    total += parseInt(range.end) - parseInt(range.start) + 1;
                }
            });
            return total;
        }

        // ì£¼ ì‹œì‘ì¼ ê³„ì‚° (ì›”ìš”ì¼)
        function getWeekStart(date) {
            const weekStart = new Date(date);
            const day = weekStart.getDay();
            const diff = day === 0 ? -6 : 1 - day;
            weekStart.setDate(weekStart.getDate() + diff);
            return weekStart;
        }

        // ë³µìŠµì¼ í† ê¸€ í•¨ìˆ˜ - í•µì‹¬ ëˆ„ë½ í•¨ìˆ˜
        function toggleReviewDate(subjectId, dateStr) {
            const subject = subjects.find(s => s.id === subjectId);
            if (!subject || !subject.pattern.reviewMode) return;
            
            const index = subject.pattern.reviewDates.indexOf(dateStr);
            if (index > -1) {
                subject.pattern.reviewDates.splice(index, 1);
            } else {
                subject.pattern.reviewDates.push(dateStr);
            }
            
            renderSubjects();
        }

        // íŒ¨í„´ í† ê¸€ í•¨ìˆ˜ë“¤
        function togglePattern(subjectId, patternId) {
            const subject = subjects.find(s => s.id === subjectId);
            if (subject) {
                subject.pattern.dayPattern = [patternId];
                subject.pattern.individualDays = [];
                renderSubjects();
            }
        }

        function toggleIndividualDay(subjectId, dayId) {
            const subject = subjects.find(s => s.id === subjectId);
            if (subject) {
                const index = subject.pattern.individualDays.indexOf(dayId);
                
                if (index > -1) {
                    subject.pattern.individualDays.splice(index, 1);
                } else {
                    subject.pattern.dayPattern = [];
                    subject.pattern.individualDays.push(dayId);
                }
                
                if (subject.pattern.individualDays.length === 0 && subject.pattern.dayPattern.length === 0) {
                    subject.pattern.dayPattern = ['daily'];
                }
                
                renderSubjects();
            }
        }

        function setRounds(subjectId, rounds) {
            const subject = subjects.find(s => s.id === subjectId);
            if (subject) {
                subject.pattern.rounds = rounds;
                
                // 2íšŒë… ì´ìƒ ì‹œ ë³µìŠµ ëª¨ë“œ ë¹„í™œì„±í™”
                if (rounds > 1) {
                    subject.pattern.reviewMode = false;
                    subject.pattern.reviewDates = [];
                }
                
                renderSubjects();
            }
        }

        function toggleReviewMode(subjectId) {
            const subject = subjects.find(s => s.id === subjectId);
            if (subject && subject.pattern.rounds === 1) {
                subject.pattern.reviewMode = !subject.pattern.reviewMode;
                if (!subject.pattern.reviewMode) {
                    subject.pattern.reviewDates = [];
                }
                renderSubjects();
            }
        }

        function setDistribution(subjectId, type) {
            const subject = subjects.find(s => s.id === subjectId);
            if (subject) {
                subject.pattern.distributionType = type;
                renderSubjects();
            }
        }

        function setDailyAmount(subjectId, amount) {
            const subject = subjects.find(s => s.id === subjectId);
            if (subject) {
                subject.pattern.dailyAmount = amount;
                renderSubjects();
            }
        }

        // ë²”ìœ„ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function addRange(subjectId) {
            const subject = subjects.find(s => s.id === subjectId);
            if (subject && subject.ranges.length < 5) {
                subject.ranges.push({ start: '', end: '' });
                renderSubjects();
            }
        }

        function removeRange(subjectId, rangeIndex) {
            const subject = subjects.find(s => s.id === subjectId);
            if (subject && subject.ranges.length > 1) {
                subject.ranges.splice(rangeIndex, 1);
                renderSubjects();
            }
        }

        function updateRange(subjectId, rangeIndex, field, value) {
            const subject = subjects.find(s => s.id === subjectId);
            if (subject && subject.ranges[rangeIndex]) {
                subject.ranges[rangeIndex][field] = value ? parseInt(value) : '';
                renderSubjects();
            }
        }

        // êµì¬ ì—…ë°ì´íŠ¸/ì‚­ì œ
        function updateSubject(id, field, value) {
            const subject = subjects.find(s => s.id === id);
            if (subject) {
                subject[field] = value;
                renderSubjects();
            }
        }

        function removeSubject(id) {
            if (subjects.length > 1) {
                subjects = subjects.filter(s => s.id !== id);
                renderSubjects();
            }
        }

        function toggleIndividual(id) {
            const subject = subjects.find(s => s.id === id);
            if (subject) {
                subject.useIndividual = !subject.useIndividual;
                if (!subject.useIndividual) {
                    subject.startDate = document.getElementById('globalStartDate').value;
                    subject.endDate = document.getElementById('globalEndDate').value;
                }
                renderSubjects();
            }
        }

        // ê°„í¸ ì…ë ¥ íŒŒì‹±
        function parseQuickInput() {
            const input = document.getElementById('quickInput').value;
            if (!input.trim()) {
                showAlert('ì…ë ¥ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const lines = input.split('\n').filter(line => line.trim());
            subjects = [];
            
            let hasValidData = false;
            lines.forEach((line) => {
                let parts;
                if (line.includes(',')) {
                    parts = line.split(',').map(p => p.trim());
                } else {
                    parts = line.split(/\t+|\s{2,}/).map(p => p.trim()).filter(p => p);
                }

                if (parts.length >= 4) {
                    const range = parts[1].split(/[-~]/);
                    if (range.length !== 2) return;

                    let startDate = parts[2];
                    let endDate = parts[3];

                    const datePattern = /(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/;
                    if (datePattern.test(startDate)) {
                        startDate = startDate.replace(datePattern, (m, y, mon, d) => {
                            return `${y}-${mon.padStart(2, '0')}-${d.padStart(2, '0')}`;
                        });
                    }
                    if (datePattern.test(endDate)) {
                        endDate = endDate.replace(datePattern, (m, y, mon, d) => {
                            return `${y}-${mon.padStart(2, '0')}-${d.padStart(2, '0')}`;
                        });
                    }

                    const subjectId = subjectIdCounter++;
                    subjects.push({
                        id: subjectId,
                        name: parts[0],
                        ranges: [{ start: parseInt(range[0]), end: parseInt(range[1]) }],
                        unitType: 'page',
                        startDate: startDate,
                        endDate: endDate,
                        useIndividual: true,
                        pattern: {
                            dayPattern: ['daily'],
                            individualDays: [],
                            rounds: 1,
                            reviewMode: false,
                            reviewDates: [],
                            distributionType: 'equal',
                            dailyAmount: 5
                        }
                    });
                    
                    hasValidData = true;
                }
            });

            if (hasValidData) {
                if (subjects.length > 0) {
                    document.getElementById('globalStartDate').value = subjects[0].startDate;
                    document.getElementById('globalEndDate').value = subjects[0].endDate;
                }
                
                renderSubjects();
                showAlert(`íŒŒì‹± ì™„ë£Œ! ${subjects.length}ê°œ êµì¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                showAlert('ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        // ê¸€ë¡œë²Œ ë‚ ì§œ ì—…ë°ì´íŠ¸
        function updateGlobalDates() {
            const startDate = document.getElementById('globalStartDate').value;
            const endDate = document.getElementById('globalEndDate').value;
            
            subjects.forEach(subject => {
                if (!subject.useIndividual) {
                    subject.startDate = startDate;
                    subject.endDate = endDate;
                }
            });
            
            renderSubjects();
            renderExcludeCalendarOptions();
        }

        // íœ´ì¼ ì œì™¸ ê´€ë ¨
        function toggleExcludeCalendar() {
            const calendar = document.getElementById('excludeCalendar');
            calendar.classList.toggle('hidden');
            if (!calendar.classList.contains('hidden')) {
                renderExcludeCalendarOptions();
            }
        }

        function renderExcludeCalendarOptions() {
            const startDate = document.getElementById('globalStartDate').value;
            const endDate = document.getElementById('globalEndDate').value;
            
            if (!startDate || !endDate) return;
            
            const select = document.getElementById('excludeMonth');
            select.innerHTML = '';
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const current = new Date(start.getFullYear(), start.getMonth(), 1);
            
            while (current <= end) {
                const option = document.createElement('option');
                option.value = `${current.getFullYear()}-${current.getMonth() + 1}`;
                option.textContent = `${current.getFullYear()}ë…„ ${current.getMonth() + 1}ì›”`;
                select.appendChild(option);
                current.setMonth(current.getMonth() + 1);
            }
            
            renderExcludeCalendar();
        }

        function renderExcludeCalendar() {
            const monthValue = document.getElementById('excludeMonth').value;
            if (!monthValue) return;
            
            const [year, month] = monthValue.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const startDay = firstDay.getDay();
            
            const calendar = document.getElementById('miniCalendar');
            calendar.innerHTML = '';
            
            ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
                const div = document.createElement('div');
                div.textContent = day;
                div.style.fontWeight = 'bold';
                div.style.textAlign = 'center';
                calendar.appendChild(div);
            });
            
            for (let i = 0; i < startDay; i++) {
                calendar.appendChild(document.createElement('div'));
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month - 1, day);
                const dateStr = formatDate(date);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                const div = document.createElement('div');
                div.className = 'calendar-day';
                if (isWeekend) div.className += ' weekend';
                if (excludedDates.has(dateStr)) div.className += ' excluded';
                
                div.textContent = day;
                div.onclick = () => toggleExcludeDate(dateStr);
                
                calendar.appendChild(div);
            }
            
            updateExcludedCount();
        }

        function toggleExcludeDate(dateStr) {
            if (excludedDates.has(dateStr)) {
                excludedDates.delete(dateStr);
            } else {
                excludedDates.add(dateStr);
            }
            renderExcludeCalendar();
            renderSubjects();
        }

        function toggleWeekends() {
            const startDate = document.getElementById('globalStartDate').value;
            const endDate = document.getElementById('globalEndDate').value;
            
            if (!startDate || !endDate) return;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const current = new Date(start);
            
            const hasWeekends = Array.from(excludedDates).some(dateStr => {
                const date = new Date(dateStr);
                return date.getDay() === 0 || date.getDay() === 6;
            });
            
            while (current <= end) {
                if (current.getDay() === 0 || current.getDay() === 6) {
                    const dateStr = formatDate(current);
                    if (hasWeekends) {
                        excludedDates.delete(dateStr);
                    } else {
                        excludedDates.add(dateStr);
                    }
                }
                current.setDate(current.getDate() + 1);
            }
            
            renderExcludeCalendar();
            renderSubjects();
        }

        function clearExcludedDates() {
            excludedDates.clear();
            renderExcludeCalendar();
            renderSubjects();
        }

        function updateExcludedCount() {
            document.getElementById('excludedCount').textContent = `ì œì™¸ëœ ë‚ ì§œ: ${excludedDates.size}ì¼`;
        }

        // ìµœì¢… ìŠ¤ì¼€ì¤„ ìƒì„±
        function generateSchedule() {
            const validSubjects = subjects.filter(s => {
                const hasValidRange = s.ranges.some(r => r.start && r.end);
                return s.name && hasValidRange && s.startDate && s.endDate;
            });

            if (validSubjects.length === 0) {
                showAlert('ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ì™„ì „í•œ êµì¬ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            schedule = [];

            validSubjects.forEach((subject, subjectIndex) => {
                const scheduleData = previewScheduleData[subject.id];
                
                if (!scheduleData || scheduleData.length === 0) {
                    showAlert(`${subject.name}: í•™ìŠµ ê°€ëŠ¥í•œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                    return;
                }
                
                scheduleData.forEach(item => {
                    schedule.push({
                        date: item.date,
                        subject: subject.name,
                        startPage: item.startPage,
                        endPage: item.endPage,
                        color: `color${subjectIndex % 6}`,
                        unitType: subject.unitType,
                        round: item.round,
                        isReview: item.isReview
                    });
                });
            });

            if (schedule.length > 0) {
                displayCalendar();
                displayStats();
                document.getElementById('resultSection').classList.remove('hidden');
                showAlert(`í•™ìŠµê³„íší‘œ ìƒì„± ì™„ë£Œ! ì´ ${schedule.length}ì¼ ê³„íš`, 'success');
            }
        }

        // ë‹¬ë ¥ í‘œì‹œ - ì¶•ì•½í˜•
        function displayCalendar() {
            const container = document.getElementById('calendarContent');
            container.innerHTML = '';

            const dailySchedule = {};
            schedule.forEach(item => {
                if (!dailySchedule[item.date]) {
                    dailySchedule[item.date] = [];
                }
                dailySchedule[item.date].push(item);
            });

            const dates = Object.keys(dailySchedule).sort();
            if (dates.length === 0) return;

            const startDate = new Date(dates[0]);
            const endDate = new Date(dates[dates.length - 1]);
            let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

            while (currentMonth <= endDate) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'calendar-month';
                monthDiv.innerHTML = `
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 500 500">
                            <circle cx="250" cy="250" r="240" fill="#FF69B4" />
                            <circle cx="250" cy="250" r="215" fill="none" stroke="#FFFFFF" stroke-width="35" />
                            <text x="250" y="176" text-anchor="middle" font-family="Arial Black, sans-serif" font-weight="900" font-size="82" fill="#FFFFFF" letter-spacing="2">STUDY</text>
                            <text x="60" y="400" font-family="Arial Rounded MT Bold, Arial, sans-serif" font-weight="900" font-size="280" fill="#FFFFFF">4</text>
                            <circle cx="350" cy="280" r="70" fill="none" stroke="#FFFFFF" stroke-width="40" />
                            <circle cx="250" cy="420" r="30" fill="#FFFFFF" />
                        </svg>
                        ${currentMonth.getFullYear()}ë…„ ${currentMonth.getMonth() + 1}ì›”
                    </h3>
                    ${generateCompactMonthCalendar(currentMonth, dailySchedule)}
                `;
                container.appendChild(monthDiv);
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }
        }

        // ì¶•ì•½í˜• ì›” ë‹¬ë ¥ ìƒì„±
        function generateCompactMonthCalendar(monthDate, dailySchedule) {
            const calendarStyle = document.getElementById('calendarStyle').value;
            const year = monthDate.getFullYear();
            const month = monthDate.getMonth();
            
            // í•´ë‹¹ ì›”ì˜ ì‚¬ìš©ë˜ëŠ” ë‚ ì§œë§Œ ì¶”ì¶œ
            const monthSchedule = {};
            const usedDaysOfWeek = new Set();
            
            Object.keys(dailySchedule).forEach(dateStr => {
                const date = new Date(dateStr);
                if (date.getFullYear() === year && date.getMonth() === month) {
                    monthSchedule[dateStr] = dailySchedule[dateStr];
                    usedDaysOfWeek.add(date.getDay());
                }
            });
            
            if (Object.keys(monthSchedule).length === 0) {
                return '<p style="text-align: center; color: #999;">ì´ ë‹¬ì—ëŠ” í•™ìŠµ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            // ì‚¬ìš©ë˜ëŠ” ìš”ì¼ì„ ì›”ìš”ì¼ ì‹œì‘ìœ¼ë¡œ ì •ë ¬
            const sortedDays = Array.from(usedDaysOfWeek).sort((a, b) => {
                const aIndex = a === 0 ? 6 : a - 1;
                const bIndex = b === 0 ? 6 : b - 1;
                return aIndex - bIndex;
            });
            
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            
            // ì£¼ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™”
            const weeks = {};
            Object.keys(monthSchedule).forEach(dateStr => {
                const date = new Date(dateStr);
                const weekStart = getWeekStart(date);
                const weekKey = formatDate(weekStart);
                
                if (!weeks[weekKey]) {
                    weeks[weekKey] = {};
                }
                
                weeks[weekKey][date.getDay()] = {
                    date: date.getDate(),
                    schedule: monthSchedule[dateStr]
                };
            });
            
            let tableClass = 'compact-final-calendar';
            if (calendarStyle === 'advanced2') tableClass += ' calendar-style-advanced2';
            
            let html = `<table class="${tableClass}"><thead><tr>`;
            
            // í—¤ë” - ì‚¬ìš©ë˜ëŠ” ìš”ì¼ë§Œ í‘œì‹œ
            sortedDays.forEach(dayIndex => {
                html += `<th>${dayNames[dayIndex]}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // ì£¼ë³„ë¡œ í–‰ ìƒì„±
            Object.keys(weeks).sort().forEach(weekKey => {
                const week = weeks[weekKey];
                html += '<tr>';
                
                sortedDays.forEach(dayIndex => {
                    const dayData = week[dayIndex];
                    
                    if (dayData) {
                        let cellClass = '';
                        if (calendarStyle === 'advanced2') {
                            if (dayIndex === 0) cellClass += ' weekend-sun';
                            else if (dayIndex === 6) cellClass += ' weekend-sat';
                        }
                        
                        const hasReview = dayData.schedule.some(item => item.isReview);
                        if (hasReview) cellClass += ' review-cell';
                        
                        html += `<td class="${cellClass}" ${hasReview ? 'style="background-color: #ffe4b5 !important;"' : ''}>`;
                        html += `<div class="date-num">${dayData.date}</div>`;
                        
                        dayData.schedule.forEach(item => {
                            const abbr = getSubjectAbbr(item.subject);
                            const unitAbbr = getUnitAbbr(item.unitType);
                            const roundSuffix = item.round > 1 ? ` (${item.round}íšŒë…)` : '';
                            const printClass = isPrintMode ? ' print-mode' : '';
                            const reviewClass = item.isReview ? ' review-task' : '';
                            const reviewSuffix = item.isReview ? ' (ë³µìŠµ)' : '';
                            
                            html += `<div class="task ${item.color}${printClass}${reviewClass}">${abbr}: ${item.startPage}-${item.endPage}${unitAbbr}${roundSuffix}${reviewSuffix}</div>`;
                        });
                        
                        html += '</td>';
                    } else {
                        html += '<td></td>';
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        // í†µê³„ í‘œì‹œ
        function displayStats() {
            const statsGrid = document.getElementById('statsGrid');
            const summaryTable = document.getElementById('summaryTable');
            
            const subjectStats = {};
            schedule.forEach(item => {
                if (!subjectStats[item.subject]) {
                    subjectStats[item.subject] = {
                        days: 0,
                        totalPages: 0,
                        unitType: item.unitType,
                        rounds: new Set(),
                        reviewDays: 0
                    };
                }
                subjectStats[item.subject].days++;
                if (item.isReview) {
                    subjectStats[item.subject].reviewDays++;
                } else {
                    subjectStats[item.subject].rounds.add(item.round);
                    subjectStats[item.subject].totalPages = Math.max(subjectStats[item.subject].totalPages, item.endPage);
                }
            });
            
            const totalSubjects = Object.keys(subjectStats).length;
            const dates = schedule.map(item => item.date).sort();
            const firstDate = new Date(dates[0]);
            const lastDate = new Date(dates[dates.length - 1]);
            const totalDays = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24)) + 1;
            const actualStudyDays = new Set(dates).size;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">ì´ êµì¬ ìˆ˜</div>
                    <div class="stat-value">${totalSubjects}ê°œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì´ ê¸°ê°„</div>
                    <div class="stat-value">${totalDays}ì¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì´ í•™ìŠµì¼</div>
                    <div class="stat-value">${actualStudyDays}ì¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì¼ì¼ í‰ê· </div>
                    <div class="stat-value">${Math.round(schedule.length / actualStudyDays * 10) / 10}ê³¼ëª©</div>
                </div>
            `;

            let tableHTML = `
                <thead>
                    <tr style="background: linear-gradient(135deg, var(--header-color-light), var(--header-color-dark));">
                        <th style="padding: 10px; border: 1px solid #ddd; color: white;">ê³¼ëª©</th>
                        <th style="padding: 10px; border: 1px solid #ddd; color: white;">íšŒë… ì²´í¬</th>
                        <th style="padding: 10px; border: 1px solid #ddd; color: white;">ì´ ë²”ìœ„</th>
                        <th style="padding: 10px; border: 1px solid #ddd; color: white;">í•™ìŠµ ì¼ìˆ˜</th>
                        <th style="padding: 10px; border: 1px solid #ddd; color: white;">ì¼ì¼ í‰ê· </th>
                        <th style="padding: 10px; border: 1px solid #ddd; color: white;">ì§„ë„ ë°°ë¶„</th>
                    </tr>
                </thead>
                <tbody>
            `;

            Object.keys(subjectStats).forEach((subject) => {
                const stats = subjectStats[subject];
                const subjectData = subjects.find(s => s.name === subject);
                const totalRange = subjectData ? calculateTotalPages(subjectData) : '-';
                const avgPages = stats.days > 0 ? Math.round(totalRange / (stats.days - stats.reviewDays) * 10) / 10 : 0;
                const distributionType = subjectData?.pattern?.distributionType === 'sequential' ? 'ìˆœì°¨ ë°°ë¶„' : 'ê· ë“± ë¶„ì‚°';
                
                let checkboxes = '';
                for (let i = 1; i <= 5; i++) {
                    const checked = stats.rounds.has(i) ? 'checked' : '';
                    checkboxes += `<input type="checkbox" ${checked} disabled> ${i} `;
                }
                
                tableHTML += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${subject}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${checkboxes}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${totalRange}${getUnitLabel(stats.unitType)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${stats.days}ì¼</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">ì•½ ${avgPages}${getUnitLabel(stats.unitType)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${distributionType}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody>';
            summaryTable.innerHTML = tableHTML;
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getUnitLabel(unitType) {
            const labels = { 'page': 'í˜ì´ì§€', 'lesson': 'ê°•', 'number': 'ë²ˆ', 'day': 'Day' };
            return labels[unitType] || 'í˜ì´ì§€';
        }

        function getUnitAbbr(unitType) {
            const abbrs = { 'page': 'p', 'lesson': 'ê°•', 'number': 'ë²ˆ', 'day': 'D' };
            return abbrs[unitType] || 'p';
        }

        function getSubjectAbbr(name) {
            const abbrs = {
                'ì¸ì…‰ì…˜ ë…í•´': 'ì¸ë…',
                'ì¸ì…‰ì…˜ ë¬¸í•™ ê°œë…ì–´': 'ì¸ë¬¸',
                'ë¬¸í•™ ë„¤ì˜¤': 'ë¬¸ë„¤',
                'ì‚¬ë³¸ ì…í…íŠ¸': 'ì‚¬ì…',
                'ê°•ê¸°ë¶„ í™”ì‘ ê°•ë¯¼ì² ': 'ê°•í™”ê°•'
            };
            
            for (let key in abbrs) {
                if (name.includes(key)) return abbrs[key];
            }
            
            return name.length > 5 ? name.substring(0, 5) : name;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ì„¤ì • íŒ¨ë„ í•¨ìˆ˜ë“¤
        function updateHeaderColor() {
            const color = document.getElementById('headerColor').value;
            document.body.className = `header-${color}`;
        }

        function updateCalendarStyle() {
            if (schedule.length > 0) {
                displayCalendar();
            }
        }

        function updateFontSize() {
            const size = document.getElementById('fontSize').value;
            const root = document.documentElement;
            root.style.setProperty('--current-font-size', `var(--font-${size})`);
        }

        function togglePrintMode() {
            isPrintMode = document.getElementById('printMode').checked;
            if (schedule.length > 0) {
                displayCalendar();
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ê¸°ë³¸ ë‚ ì§œ ì„¤ì •
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
            document.getElementById('globalStartDate').value = formatDate(today);
            document.getElementById('globalEndDate').value = formatDate(nextMonth);
            
            addSubject();
        });
    </script>
</body>
</html>